<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>수질자동측정기기 현장확인서</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        .container {
            width: 210mm;
            height: 297mm;
            margin: auto;
            padding: 20px;
            border: 1px solid #000;
            box-sizing: border-box;
            position: relative;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid #000;
            padding: 8px;
            text-align: center;
            box-sizing: border-box;
            font-size: 14px;
        }
        th {
            background-color: #f2f2f2;
        }
        .checkbox {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 5px;
            vertical-align: middle;
        }
        .test-options {
            text-align: left;
            white-space: nowrap;
        }
        .test-options label {
            display: block;
            margin-bottom: 5px;
        }
        .textarea-cell {
            height: 300px;
            text-align: left;
            vertical-align: top;
        }
        .table-cell {
            width: 90px;
            height: 3em;
        }
        .signature {
            width: 300px;
            height: 100px;
            position: relative;
        }
        .signature canvas {
            width: 100%;
            height: 100%;
            border: 1px solid #000;
        }
        .signature-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(0, 0, 0, 0.5);
            pointer-events: none;
            user-select: none;
        }
        .notice {
            font-size: 12px;
        }
        .wide-cell {
            width: 200px;
        }
        .fep-cell {
            font-size: 12px;
        }
        select, input[type="date"], textarea {
            width: 100%;
            box-sizing: border-box;
            padding: 5px;
            font-size: 12px;
        }
        input[type="date"] {
            cursor: pointer;
        }
        .button-container {
            text-align: center;
            margin-top: 20px;
        }
        .button-container button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        .small-font {
            font-size: 10px;
        }
        .hidden-border {
            border: none !important;
        }
        .hidden {
            display: none;
        }
        .dropdown-container {
            position: relative;
            width: 100%;
        }
        .dropdown-input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            font-size: 12px;
            line-height: 1.5;
            height: auto;
        }
        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 150px;
            border: 1px solid #ccc;
            background-color: white;
            overflow-y: auto;
            z-index: 1000;
        }
        .dropdown-item {
            padding: 5px;
            cursor: pointer;
        }
        .dropdown-item:hover {
            background-color: #f0f0f0;
        }
        .hidden {
            display: none;
        }
    </style>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        // OAuth 2.0 클라이언트 ID 및 API 키 설정
        const CLIENT_ID = 'YOUR_CLIENT_ID';
        const API_KEY = 'YOUR_API_KEY';

        // API 로드 후 호출되는 콜백 함수
        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }

        // API 초기화
        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
                scope: "https://www.googleapis.com/auth/spreadsheets"
            }).then(() => {
                // 인증 상태 변경 리스너 추가
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

                // 초기 인증 상태 확인
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());

                // 로그인 버튼 및 이벤트 리스너 설정
                document.getElementById('authorize_button').onclick = handleAuthClick;
                document.getElementById('signout_button').onclick = handleSignoutClick;
            });
        }

        // 인증 상태 업데이트
        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                document.getElementById('authorize_button').style.display = 'none';
                document.getElementById('signout_button').style.display = 'block';
            } else {
                document.getElementById('authorize_button').style.display = 'block';
                document.getElementById('signout_button').style.display = 'none';
            }
        }

        // 로그인 처리
        function handleAuthClick(event) {
            gapi.auth2.getAuthInstance().signIn();
        }

        // 로그아웃 처리
        function handleSignoutClick(event) {
            gapi.auth2.getAuthInstance().signOut();
        }

        // 스프레드시트 업데이트
        function updateSpreadsheet(range, values) {
            gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: 'YOUR_SPREADSHEET_ID',
                range: range,
                valueInputOption: 'RAW',
                resource: { values: values }
            }).then(response => {
                console.log('Sheet updated successfully', response);
            }, error => {
                console.error('Error updating sheet', error);
            });
        }
    </script>
</head>
<body onload="handleClientLoad()">
    <div class="container" id="pdf-content">
        <h1>수질자동측정기기 현장확인서</h1>
        <table>
            <tr>
                <th>사업장명</th>
                <td colspan="4">
                    <div class="dropdown-container">
                        <input type="text" class="dropdown-input" placeholder="선택 또는 검색" id="business-input">
                        <div class="dropdown-list hidden" id="business-list">
                            <div class="dropdown-item" data-value="">선택</div>
                        </div>
                    </div>
                </td>
                <th>방류구번호</th>
                <td colspan="2">
                    <div class="dropdown-container">
                        <input type="text" class="dropdown-input" placeholder="선택 또는 검색" id="discharge-input">
                        <div class="dropdown-list hidden" id="discharge-list">
                            <div class="dropdown-item" data-value="">선택</div>
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <th>시험일자</th>
                <td colspan="7"><input type="date"></td>
            </tr>
            <tr>
                <th rowspan="2">측정기 모델<br>(제작사, 제작국)</th>
                <th class="table-cell">pH</th>
                <th class="table-cell">SS</th>
                <th class="table-cell">TOC</th>
                <th class="table-cell">TN</th>
                <th class="table-cell">TP</th>
                <th class="table-cell">유량계</th>
                <th class="table-cell">자동시료채취기</th>
            </tr>
            <tr>
                <td class="table-cell" style="height: 9em;">
                    <div class="dropdown-container">
                        <input type="text" class="dropdown-input" placeholder="선택 또는 검색" id="ph-input">
                        <div class="dropdown-list hidden" id="ph-list">
                            <div class="dropdown-item" data-value="">선택</div>
                        </div>
                    </div>
                </td>
                <td class="table-cell" style="height: 9em;">
                    <div class="dropdown-container">
                        <input type="text" class="dropdown-input" placeholder="선택 또는 검색" id="ss-input">
                        <div class="dropdown-list hidden" id="ss-list">
                            <div class="dropdown-item" data-value="">선택</div>
                        </div>
                    </div>
                </td>
                <td class="table-cell" style="height: 9em;">
                    <div class="dropdown-container">
                        <input type="text" class="dropdown-input" placeholder="선택 또는 검색" id="toc-input">
                        <div class="dropdown-list hidden" id="toc-list">
                            <div class="dropdown-item" data-value="">선택</div>
                        </div>
                    </div>
                </td>
                <td class="table-cell" style="height: 9em;">
                    <div class="dropdown-container">
                        <input type="text" class="dropdown-input" placeholder="선택 또는 검색" id="tn-input">
                        <div class="dropdown-list hidden" id="tn-list">
                            <div class="dropdown-item" data-value="">선택</div>
                        </div>
                    </div>
                </td>
                <td class="table-cell" style="height: 9em;">
                    <div class="dropdown-container">
                        <input type="text" class="dropdown-input" placeholder="선택 또는 검색" id="tp-input">
                        <div class="dropdown-list hidden" id="tp-list">
                            <div class="dropdown-item" data-value="">선택</div>
                        </div>
                    </div>
                </td>
                <td class="table-cell" style="height: 9em;">
                    <div class="dropdown-container">
                        <input type="text" class="dropdown-input" placeholder="선택 또는 검색" id="flowmeter-input">
                        <div class="dropdown-list hidden" id="flowmeter-list">
                            <div class="dropdown-item" data-value="">선택</div>
                        </div>
                    </div>
                </td>
                <td class="table-cell" style="height: 9em;">
                    <div class="dropdown-container">
                        <input type="text" class="dropdown-input" placeholder="선택 또는 검색" id="sampler-input">
                        <div class="dropdown-list hidden" id="sampler-list">
                            <div class="dropdown-item" data-value="">선택</div>
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <th>전송기 모델<br>(모델명, 버전)</th>
                <td colspan="3">
                    <div class="dropdown-container">
                        <input type="text" class="dropdown-input" placeholder="선택 또는 검색" id="transmitter-input">
                        <div class="dropdown-list hidden" id="transmitter-list">
                            <div class="dropdown-item" data-value="">선택</div>
                        </div>
                    </div>
                </td>
                <th class="fep-cell">FEP<br>(모델명, 버전)</th>
                <td colspan="3" class="fep-cell">
                    <div class="dropdown-container">
                        <input type="text" class="dropdown-input" placeholder="선택 또는 검색" id="fep-input">
                        <div class="dropdown-list hidden" id="fep-list">
                            <div class="dropdown-item" data-value="">선택</div>
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td rowspan="4" class="test-options">
                    <label><input type="checkbox" class="checkbox" id="chk1"> 통합시험</label>
                    <label><input type="checkbox" class="checkbox" id="chk2"> 확인검사</label>
                    <label><input type="checkbox" class="checkbox" id="chk3"> 상대정확도시험</label>
                </td>
                <td colspan="7" class="textarea-cell">
                    <div id="auto-generated-text" style="padding-bottom: 10px;"></div>
                    <textarea style="height: calc(100% - 30px);"></textarea>
                </td>
            </tr>
            <tr>
                <th>사업장</th>
                <td colspan="2" class="wide-cell">
                    <div class="dropdown-container">
                        <input type="text" class="dropdown-input" placeholder="선택 또는 검색" id="company-input">
                        <div class="dropdown-list hidden" id="company-list">
                            <div class="dropdown-item" data-value="">선택</div>
                        </div>
                    </div>
                </td>
                <td colspan="2" class="signature">
                    <canvas class="signature-pad" id="signature-pad-1"></canvas>
                    <div class="signature-label">성명</div>
                    <button type="button" class="clear-signature" data-target="signature-pad-1">지우기</button>
                </td>
                <td colspan="2" class="signature">
                    <canvas class="signature-pad" id="signature-pad-2"></canvas>
                    <div class="signature-label">서명</div>
                    <button type="button" class="clear-signature" data-target="signature-pad-2">지우기</button>
                </td>
            </tr>
            <tr>
                <th class="small-font">유지관리 업체</th>
                <td colspan="2" class="wide-cell">
                    <div class="dropdown-container">
                        <input type="text" class="dropdown-input" placeholder="선택 또는 검색" id="maintenance-input">
                        <div class="dropdown-list hidden" id="maintenance-list">
                            <div class="dropdown-item" data-value="">선택</div>
                        </div>
                    </div>
                </td>
                <td colspan="2" class="signature">
                    <canvas class="signature-pad" id="signature-pad-3"></canvas>
                    <div class="signature-label">성명</div>
                    <button type="button" class="clear-signature" data-target="signature-pad-3">지우기</button>
                </td>
                <td colspan="2" class="signature">
                    <canvas class="signature-pad" id="signature-pad-4"></canvas>
                    <div class="signature-label">서명</div>
                    <button type="button" class="clear-signature" data-target="signature-pad-4">지우기</button>
                </td>
            </tr>
            <tr>
                <th class="small-font">관제센터</th>
                <td colspan="2" class="wide-cell">
                    <div class="dropdown-container">
                        <input type="text" class="dropdown-input" placeholder="선택 또는 검색" id="control-input">
                        <div class="dropdown-list hidden" id="control-list">
                            <div class="dropdown-item" data-value="">선택</div>
                        </div>
                    </div>
                </td>
                <td colspan="2" class="signature">
                    <canvas class="signature-pad" id="signature-pad-5"></canvas>
                    <div class="signature-label">성명</div>
                    <button type="button" class="clear-signature" data-target="signature-pad-5">지우기</button>
                </td>
                <td colspan="2" class="signature">
                    <canvas class="signature-pad" id="signature-pad-6"></canvas>
                    <div class="signature-label">서명</div>
                    <button type="button" class="clear-signature" data-target="signature-pad-6">지우기</button>
                </td>
            </tr>
        </table>
        <p class="notice">※ 이외에 관제센터에서의 사후 확인과정에서 추가로 문제점이 발견될 수 있습니다.</p>
    </div>
    <div class="button-container">
        <button id="submit-btn">제출</button>
        <button id="authorize_button" style="display: none;">Authorize</button>
        <button id="signout_button" style="display: none;">Sign Out</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const signaturePads = {};

            document.querySelectorAll(".signature-pad").forEach(canvas => {
                const signaturePad = new SignaturePad(canvas, {
                    backgroundColor: 'rgb(255, 255, 255)'
                });
                signaturePads[canvas.id] = signaturePad;

                function resizeCanvas() {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                    signaturePad.clear();
                }

                window.addEventListener("resize", resizeCanvas);
                resizeCanvas();
            });

            document.querySelectorAll('.clear-signature').forEach(button => {
                button.addEventListener('click', function() {
                    const target = this.getAttribute('data-target');
                    signaturePads[target].clear();
                });
            });

            const autoGeneratedText = document.getElementById('auto-generated-text');
            const checkboxes = document.querySelectorAll('.checkbox');

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateAutoGeneratedText);
            });

            function updateAutoGeneratedText() {
                const chk1 = document.getElementById('chk1').checked;
                const chk2 = document.getElementById('chk2').checked;
                const chk3 = document.getElementById('chk3').checked;

                let text = '';
                if (chk1 && chk2 && chk3) {
                    text = '수질TMS 개선완료에 따른 통합 및 정도확인시험';
                } else if (chk1 && chk2) {
                    text = '수질TMS 개선완료에 따른 통합 및 확인검사';
                } else if (chk1 && chk3) {
                    text = '수질TMS 개선완료에 따른 통합 및 상대정확도시험';
                } else if (chk2 && chk3) {
                    text = '수질TMS 개선완료에 따른 정도확인시험';
                } else if (chk1) {
                    text = '수질TMS 개선완료에 따른 통합시험';
                } else if (chk2) {
                    text = '수질TMS 개선완료에 따른 확인검사';
                } else if (chk3) {
                    text = '수질TMS 개선완료에 따른 상대정확도시험';
                }
                autoGeneratedText.textContent = text;
            }

            document.getElementById('submit-btn').addEventListener('click', function() {
                const businessInput = document.getElementById('business-input').value;
                const dischargeInput = document.getElementById('discharge-input').value;
                const phInput = document.getElementById('ph-input').value;
                const ssInput = document.getElementById('ss-input').value;
                const tocInput = document.getElementById('toc-input').value;
                const tnInput = document.getElementById('tn-input').value;
                const tpInput = document.getElementById('tp-input').value;
                const flowmeterInput = document.getElementById('flowmeter-input').value;
                const samplerInput = document.getElementById('sampler-input').value;
                const transmitterInput = document.getElementById('transmitter-input').value;
                const fepInput = document.getElementById('fep-input').value;
                const companyInput = document.getElementById('company-input').value;
                const maintenanceInput = document.getElementById('maintenance-input').value;

                const values = [
                    [businessInput, dischargeInput, phInput, ssInput, tocInput, tnInput, tpInput, flowmeterInput, samplerInput, transmitterInput, fepInput, companyInput, maintenanceInput]
                ];

                updateSpreadsheet('Sheet1!A2:M2', values);
            });

            const dropdownContainers = document.querySelectorAll('.dropdown-container');

            dropdownContainers.forEach(container => {
                const input = container.querySelector('.dropdown-input');
                const list = container.querySelector('.dropdown-list');

                input.addEventListener('focus', function () {
                    list.classList.remove('hidden');
                });

                input.addEventListener('input', function () {
                    const filter = this.value.toLowerCase();
                    const items = list.querySelectorAll('.dropdown-item');

                    items.forEach(item => {
                        const text = item.textContent.toLowerCase();
                        item.style.display = text.includes(filter) ? '' : 'none';
                    });
                });

                list.addEventListener('click', function (event) {
                    if (event.target.classList.contains('dropdown-item')) {
                        input.value = event.target.textContent;
                        list.classList.add('hidden');
                        if (input.id === 'business-input') {
                            fillDataForBusiness(event.target.textContent);
                        }
                    }
                });

                document.addEventListener('click', function (event) {
                    if (!container.contains(event.target)) {
                        list.classList.add('hidden');
                    }
                });
            });

            async function fetchSpreadsheetData() {
                const apiKey = 'YOUR_API_KEY';
                const spreadsheetId = 'YOUR_SPREADSHEET_ID';
                const range = 'Sheet1';

                try {
                    const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    return data.values;
                } catch (error) {
                    console.error('구글 스프레드시트 데이터를 가져오는 중 오류가 발생했습니다:', error);
                }
            }

            let spreadsheetData = [];

            async function updateDropdowns() {
                const data = await fetchSpreadsheetData();
                if (data) {
                    spreadsheetData = data;

                    const dropdowns = {
                        business: document.getElementById('business-list'),
                        discharge: document.getElementById('discharge-list'),
                        ph: document.getElementById('ph-list'),
                        ss: document.getElementById('ss-list'),
                        toc: document.getElementById('toc-list'),
                        tn: document.getElementById('tn-list'),
                        tp: document.getElementById('tp-list'),
                        flowmeter: document.getElementById('flowmeter-list'),
                        sampler: document.getElementById('sampler-list'),
                        transmitter: document.getElementById('transmitter-list'),
                        fep: document.getElementById('fep-list'),
                        company: document.getElementById('company-list'),
                        maintenance: document.getElementById('maintenance-list'),
                        control: document.getElementById('control-list')
                    };

                    for (let key in dropdowns) {
                        dropdowns[key].innerHTML = '<div class="dropdown-item" data-value="">선택</div>';
                    }

                    for (let i = 0; i < data.length; i++) {
                        const row = data[i];
                        for (let j = 0; j < row.length; j++) {
                            const item = document.createElement('div');
                            item.classList.add('dropdown-item');
                            item.setAttribute('data-value', row[j]);
                            item.textContent = row[j];
                            if (dropdowns[Object.keys(dropdowns)[j]]) {
                                dropdowns[Object.keys(dropdowns)[j]].appendChild(item);
                            }
                        }
                    }
                }
            }

            function fillDataForBusiness(businessName) {
                const businessRow = spreadsheetData.find(row => row[0] === businessName);
                if (businessRow) {
                    document.getElementById('ph-input').value = businessRow[1] || '';
                    document.getElementById('ss-input').value = businessRow[2] || '';
                    document.getElementById('toc-input').value = businessRow[3] || '';
                    document.getElementById('tn-input').value = businessRow[4] || '';
                    document.getElementById('tp-input').value = businessRow[5] || '';
                    document.getElementById('flowmeter-input').value = businessRow[6] || '';
                    document.getElementById('sampler-input').value = businessRow[7] || '';
                    document.getElementById('transmitter-input').value = businessRow[8] || '';
                    document.getElementById('fep-input').value = businessRow[9] || '';
                    document.getElementById('company-input').value = businessRow[10] || '';
                    document.getElementById('maintenance-input').value = businessRow[11] || '';
                }
            }

            updateDropdowns();
        });
    </script>
</body>
</html>
